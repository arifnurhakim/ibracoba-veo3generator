<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTIMATE COMMAND GENERATOR</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        input, select, textarea {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
            outline: none;
            color: #374151;
        }
        textarea {
            resize: vertical;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
        }
        textarea:read-only {
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        button {
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-primary { background-color: #6366f1; color: #ffffff; }
        .btn-primary:hover:not(:disabled) { background-color: #4f46e5; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .btn-success { background-color: #10b981; color: #ffffff; }
        .btn-success:hover { background-color: #059669; }
        .btn-danger { background-color: #ef4444; color: #ffffff; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-warning { background-color: #f59e0b; color: #ffffff; }
        .btn-warning:hover { background-color: #d97706; }
        textarea.prompt-output {
            min-height: 150px;
            background-color: #f9fafb;
            color: #1f2937;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .section-title { @apply text-xl font-semibold text-gray-800 mt-8 mb-4 border-b pb-2 border-gray-200; }
        .character-block, .product-block, .scene-block { @apply bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200; }
        .dialog-content-block { @apply bg-blue-50 p-3 rounded-lg mt-2 mb-2 border border-blue-200; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 700px; text-align: center; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #6366f1; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .story-option {
            padding: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .story-option:hover {
            border-color: #6366f1;
            background-color: #eef2ff;
        }
        .dual-input > select { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .dual-input > input { border-top-left-radius: 0; border-bottom-left-radius: 0; border-left: 0; }
        .section-summary {
            cursor: pointer;
        }
        .section-summary .arrow {
            transition: transform 0.2s ease-in-out;
        }
        details[open] > .section-summary .arrow {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">ULTIMATE COMMAND GENERATOR</h1>
        <p class="text-center text-red-500 text-sm mb-6">
            APLIKASI INI DIBUAT OLEH <span class="font-bold">Papahnya Ibracobra</span>
        </p>

        <!-- API Key Input -->
        <div class="mb-6 bg-purple-50 border border-purple-200 p-4 rounded-lg">
            <label for="apiKeyInput" class="block text-gray-800 text-sm font-medium mb-2">Google AI API Key Anda:</label>
            <input type="password" id="apiKeyInput" placeholder="Masukkan Google AI API Key Anda" class="w-full">
            <p class="text-xs text-gray-500 mt-1">Dapatkan kunci dari <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-600 hover:underline">Google AI Studio</a>. Kunci tidak disimpan dan hanya digunakan di browser Anda.</p>
        </div>
        
        <h2 class="section-title">Mulai di Sini: Konsep & Ide</h2>

        <!-- General Settings & Smart Generator -->
        <div class="md:col-span-2 bg-indigo-50 p-4 rounded-lg border border-indigo-200 mb-4">
            <label for="mainTheme" class="block text-gray-700 text-sm font-medium mb-2">Ide Pokok / Tema Utama Video:</label>
            <textarea id="mainTheme" rows="3" placeholder="Tulis ide Anda di sini, atau klik 'Kembangkan Opsi Cerita' untuk bantuan AI."></textarea>
            
            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="videoType" class="block text-gray-700 text-sm font-medium mb-2">Gaya Visual Video:</label>
                    <select id="videoType">
                        <option value="" selected>Pilih...</option>
                        <option value="video sinematik">Video Sinematik</option> <option value="animasi pendek">Animasi Pendek</option> <option value="cuplikan iklan">Cuplikan Iklan</option> <option value="video dokumenter">Video Dokumenter</option> <option value="gaya vlog">Gaya Vlog</option> <option value="video musik">Video Musik</option> <option value="cuplikan film">Cuplikan Film</option> <option value="video time-lapse">Video Time-Lapse</option> <option value="video stop-motion">Video Stop-Motion</option>
                    </select>
                </div>
                 <div>
                    <label for="cameraStyle" class="block text-gray-700 text-sm font-medium mb-2">Gaya Video:</label>
                     <div class="flex dual-input">
                        <select id="cameraStyle">
                            <option value="" selected>Pilih...</option>
                            <option value="Realistis">Realistis</option>
                            <option value="Animasi 3D">Animasi 3D</option>
                            <option value="Animasi 2D">Animasi 2D</option>
                            <option value="Disney Pixar">Disney Pixar</option>
                            <option value="Anime">Anime</option>
                            <option value="Lukisan minyak">Lukisan minyak</option>
                            <option value="Gaya sketsa">Gaya sketsa</option>
                            <option value="Cyberpunk">Cyberpunk</option>
                            <option value="Fantasi">Fantasi</option>
                        </select>
                        <input type="text" id="cameraStyle-free" placeholder="Atau isi sendiri...">
                    </div>
                </div>
                <div>
                    <label for="videoMood" class="block text-gray-700 text-sm font-medium mb-2">Suasana Video:</label>
                    <div class="flex dual-input">
                        <select id="videoMood">
                            <option value="" selected>Pilih...</option>
                            <option value="ceria dan penuh semangat">Ceria dan penuh semangat</option>
                            <option value="misterius dan menegangkan">Misterius dan menegangkan</option>
                            <option value="tenang dan damai">Tenang dan damai</option>
                            <option value="sedih dan melankolis">Sedih dan melankolis</option>
                            <option value="epik dan heroik">Epik dan heroik</option>
                            <option value="komedi dan lucu">Komedi dan lucu</option>
                        </select>
                        <input type="text" id="videoMood-free" placeholder="Atau isi sendiri...">
                    </div>
                </div>
            </div>
            
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="smartSceneCount" class="block text-xs font-medium text-gray-600 mb-1">Jumlah Adegan:</label>
                    <input type="number" id="smartSceneCount" value="3" min="1" max="10" class="w-full !py-2">
                </div>
                <div class="sm:col-span-2 flex flex-col sm:flex-row gap-2">
                    <button id="getStoryOptionsBtn" class="btn-secondary w-full">✨ Kembangkan Opsi Cerita</button>
                    <button id="developIdeaBtn" class="btn-primary w-full">✨ Kembangkan Ide Menjadi Detail</button>
                </div>
            </div>
            <div id="smart-loader" class="loader hidden mt-4 mx-auto"></div>
            
            <div id="storyOptionsDisplayArea" class="mt-4 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-md font-semibold text-gray-800">Pilih Opsi Cerita:</h4>
                    <button id="closeStoryOptions" class="text-gray-500 hover:text-gray-800 text-sm">Tutup</button>
                </div>
                <div id="story-options-loader" class="loader hidden mx-auto my-4"></div>
                <div id="storyOptionsContainer" class="space-y-3 text-left max-h-96 overflow-y-auto p-2 border-t border-indigo-200">
                </div>
            </div>
        </div>

        <h2 class="section-title">Detail Manual (Opsional)</h2>
        
        <details>
            <summary class="section-summary text-lg font-semibold text-gray-700 mt-6 mb-3 flex justify-between items-center">
                <span>A. Isi Otomatis dari Gambar (Referensi)</span>
                <span class="arrow">▼</span>
            </summary>
            <div class="bg-gray-50 p-4 rounded-lg mb-8 border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="imageUpload" class="block text-gray-700 text-sm font-medium mb-2">Unggah Gambar:</label>
                        <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-900 bg-white rounded-lg border border-gray-300 cursor-pointer focus:outline-none p-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                    <div>
                        <label for="imageTarget" class="block text-gray-700 text-sm font-medium mb-2">Target Deskripsi:</label>
                        <select id="imageTarget"></select>
                    </div>
                </div>
                 <div id="image-preview-container" class="mt-4 hidden text-center">
                    <p class="text-sm font-medium text-gray-700 mb-2">Pratinau Gambar:</p>
                    <img id="imagePreview" src="#" alt="Pratinau Gambar" class="max-h-48 rounded-lg shadow-md inline-block"/>
                </div>
                <div class="mt-4 flex items-center gap-4">
                    <button id="generateFromImageBtn" class="btn-primary" disabled>Isi Otomatis dari Gambar</button>
                    <div id="image-loader" class="loader hidden"></div>
                </div>
                <div class="mt-4">
                    <label for="generalSubject" class="block text-gray-700 text-sm font-medium mb-2">Deskripsi Otomatis dari Gambar:</label>
                    <textarea id="generalSubject" rows="2" placeholder="Hasil deskripsi dari fitur gambar akan muncul di sini..." readonly></textarea>
                </div>
                <p class="text-xs text-gray-500 mt-2">AI akan otomatis mendeteksi semua karakter. Gunakan dropdown untuk menargetkan ulang deskripsi jika perlu.</p>
            </div>
        </details>

        <details>
            <summary class="section-summary text-lg font-semibold text-gray-700 mt-6 mb-3 flex justify-between items-center">
                <span>B. Karakter</span>
                <span class="arrow">▼</span>
            </summary>
            <div id="characterInputsContainer"></div>
            <div class="flex justify-center my-4"><button id="addCharacterBtn" class="btn-secondary">Tambah Karakter Manual</button></div>
        </details>
        
        <details>
            <summary class="section-summary text-lg font-semibold text-gray-700 mt-6 mb-3 flex justify-between items-center">
                <span>C. Produk</span>
                <span class="arrow">▼</span>
            </summary>
            <div id="productInputsContainer"></div>
            <div class="flex justify-center my-4"><button id="addProductBtn" class="btn-secondary">Tambah Produk</button></div>
        </details>

        <details>
            <summary class="section-summary text-lg font-semibold text-gray-700 mt-6 mb-3 flex justify-between items-center">
                <span>D. Latar Umum</span>
                <span class="arrow">▼</span>
            </summary>
            <div class="bg-gray-50 p-4 rounded-lg mb-4 border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                    <div class="md:col-span-2"><label for="location" class="block text-gray-700 text-sm font-medium mb-2">Lokasi:</label><textarea id="location" rows="3" placeholder="Contoh: Di puncak gunung bersalju; Jalanan kota Tokyo yang ramai"></textarea></div>
                    
                    <div>
                        <label for="time" class="block text-gray-700 text-sm font-medium mb-2">Waktu:</label>
                        <div class="flex dual-input"><select id="time"><option value="" selected>Pilih...</option><option value="pagi hari">Pagi</option><option value="siang hari">Siang</option><option value="sore hari">Sore</option><option value="malam hari">Malam</option><option value="fajar">Fajar</option><option value="senja">Senja</option></select><input type="text" id="time-free" placeholder="Atau isi sendiri..."></div>
                    </div>
                    <div>
                        <label for="weather" class="block text-gray-700 text-sm font-medium mb-2">Cuaca:</label>
                        <div class="flex dual-input"><select id="weather"><option value="" selected>Pilih...</option><option value="cerah">Cerah</option><option value="berawan">Berawan</option><option value="hujan">Hujan</option><option value="bersalju">Bersalju</option><option value="berkabut">Berkabut</option><option value="badai">Badai</option></select><input type="text" id="weather-free" placeholder="Atau isi sendiri..."></div>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-medium mb-2">Musim:</label>
                        <div class="flex dual-input"><select id="season"><option value="" selected>Pilih...</option><option value="semi">Semi</option><option value="panas">Panas</option><option value="gugur">Gugur</option><option value="dingin">Dingin</option></select><input type="text" id="season-free" placeholder="Atau isi sendiri..."></div>
                    </div>
                </div>
                <div class="mt-4">
                    <button id="generateBackgroundBtn" class="btn-secondary w-full">✨ Generate Latar Kreatif</button>
                </div>
                <div id="background-loader" class="loader hidden mt-4 mx-auto"></div>
            </div>
        </details>

        <details>
            <summary class="section-summary text-lg font-semibold text-gray-700 mt-6 mb-3 flex justify-between items-center">
                <span>E. Rangkaian Adegan (Shoots)</span>
                <span class="arrow">▼</span>
            </summary>
            <div id="sceneInputsContainer"></div>
            <div class="flex justify-center my-4"><button id="addSceneBtn" class="btn-secondary">Tambah Adegan</button></div>
        </details>

        <details>
            <summary class="section-summary text-lg font-semibold text-gray-700 mt-6 mb-3 flex justify-between items-center">
                <span>F. Pengaturan Akhir</span>
                <span class="arrow">▼</span>
            </summary>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div><label for="videoQuality" class="block text-gray-700 text-sm font-medium mb-2">Kualitas Video:</label><select id="videoQuality"><option value="HD">HD (720p)</option><option value="Full HD">Full HD (1080p)</option><option value="4K">4K (2160p)</option><option value="8K">8K (4320p)</option></select></div>
                <div><label for="videoRatio" class="block text-gray-700 text-sm font-medium mb-2">Rasio Video:</label><select id="videoRatio"><option value="LANDSCAPE 16:9">LANDSCAPE 16:9</option><option value="PORTRAIT 9:16">PORTRAIT 9:16</option></select></div>
                <div class="md:col-span-3"><label for="additionalDetails" class="block text-gray-700 text-sm font-medium mb-2">Detail Tambahan Umum:</label><textarea id="additionalDetails" rows="2" placeholder="Detail lain yang berlaku untuk seluruh video"></textarea></div>
                <div class="md:col-span-3">
                    <label for="negativePrompt" class="block text-gray-700 text-sm font-medium mb-2">Negative Prompt (Hal yang Dihindari):</label>
                     <div class="flex items-center gap-2">
                        <textarea id="negativePrompt" rows="2" placeholder="Contoh: teks, logo, blur, distorsi wajah" class="flex-grow"></textarea>
                        <button id="getNegativeSuggestionBtn" class="btn-secondary flex-shrink-0 !px-3" title="Dapatkan Saran Negative Prompt dari AI">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        </button>
                     </div>
                </div>
            </div>
        </details>
        
        <div class="flex justify-center flex-wrap gap-4 mb-4 border-t border-gray-200 pt-8">
            <button id="generateBtn" class="btn-primary">Susun Prompt Terstruktur</button>
            <button id="clearBtn" class="btn-secondary">Bersihkan & Reset Semua</button>
        </div>

        <h2 class="text-xl font-semibold text-gray-800 mb-4">Hasil Akhir:</h2>
        <div class="mb-2 relative">
            <label for="promptId" class="block text-gray-700 text-sm font-medium mb-2">Prompt Final :</label>
            <div class="flex items-start gap-2">
                <textarea id="promptId" class="prompt-output flex-grow"></textarea>
                <div class="flex flex-col gap-2">
                    <button id="copy-prompt-id-btn" class="btn-secondary !p-2" title="Salin Prompt">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- AI COMMAND & EXPORT/IMPORT SECTION -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <div class="mb-8 p-4 bg-green-50 border border-green-200 rounded-lg">
                <label for="aiFinalCommand" class="block text-gray-800 text-sm font-medium mb-2">Perintah Tambahan untuk AI (Opsional):</label>
                <textarea id="aiFinalCommand" rows="2" placeholder="Contoh: Buat lebih puitis, persingkat menjadi 1000 huruf..."></textarea>
                <div class="mt-3 flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                    <button id="executeAiCommandBtn" class="btn-success w-full sm:w-auto">Jalankan Perintah AI</button>
                    <button id="ultimateCommandBtn" class="btn-warning w-full sm:w-auto" title="Ultimate Command: Pecah Prompt per Adegan">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        <span>Ultimate Command</span>
                    </button>
                    <div id="ai-command-loader" class="loader hidden ml-2"></div>
                </div>
            </div>
             <div class="flex justify-center flex-wrap gap-4">
                <button id="exportBtn" class="btn-warning">Ekspor Pengaturan</button>
                <button id="importBtn" class="btn-warning">Impor Pengaturan</button>
            </div>
        </div>
    </div>
    
    <!-- TEMPLATES -->
    <template id="characterTemplate">
        <div class="character-block" data-character-id="">
            <div class="flex justify-between items-center mb-4"><h4 class="font-semibold text-gray-700 text-lg">Karakter</h4><button type="button" class="remove-character-btn btn-danger text-xs px-2 py-1">Hapus</button></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-gray-700 text-sm font-medium mb-2">Nama Karakter:</label><input type="text" class="character-name" placeholder="Contoh: Budi, Susan" required></div>
                <div><label class="block text-gray-700 text-sm font-medium mb-2">Ras/Etnis:</label><input type="text" class="character-race" placeholder="Contoh: Asia, Kaukasia"></div>
                <div><label class="block text-gray-700 text-sm font-medium mb-2">Perkiraan Usia:</label><input type="text" class="character-age" placeholder="Contoh: 25 tahun"></div>
                <div><label class="block text-gray-700 text-sm font-medium mb-2">Bentuk Tubuh:</label><input type="text" class="character-body-shape" placeholder="Contoh: Atletis, Langsing"></div>
                <div><label class="block text-gray-700 text-sm font-medium mb-2">Perkiraan Tinggi Badan:</label><input type="text" class="character-height" placeholder="Contoh: 175 cm"></div>
                <div><label class="block text-gray-700 text-sm font-medium mb-2">Kewarganegaraan:</label><input type="text" class="character-nationality" placeholder="Contoh: Indonesia"></div>
                
                <div class="md:col-span-2">
                    <details class="bg-white border border-gray-200 rounded-lg p-3">
                        <summary class="font-semibold text-gray-700 cursor-pointer">Detail Wajah & Rambut Konsisten (Klik untuk Buka)</summary>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-6">
                            
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Bentuk Wajah:</label>
                                <div class="flex dual-input"><select class="character-face-shape mt-1"><option value="">Pilih...</option><option value="oval">Oval</option><option value="bulat">Bulat</option><option value="kotak">Kotak</option><option value="hati">Hati</option><option value="panjang">Panjang</option></select><input type="text" class="character-face-shape-free mt-1 text-sm" placeholder="Isi sendiri..."></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Warna Mata:</label>
                                <div class="flex dual-input"><select class="character-eye-color mt-1"><option value="">Pilih...</option><option value="coklat">Coklat</option><option value="hitam">Hitam</option><option value="biru">Biru</option><option value="hijau">Hijau</option><option value="abu-abu">Abu-abu</option><option value="amber">Amber</option></select><input type="text" class="character-eye-color-free mt-1 text-sm" placeholder="Isi sendiri..."></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Bentuk Mata:</label>
                                <div class="flex dual-input"><select class="character-eye-shape mt-1"><option value="">Pilih...</option><option value="almond">Almond</option><option value="bulat">Bulat</option><option value="sipit">Sipit</option><option value="besar">Besar</option></select><input type="text" class="character-eye-shape-free mt-1 text-sm" placeholder="Isi sendiri..."></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Bentuk Alis:</label>
                                <div class="flex dual-input"><select class="character-eyebrow-shape mt-1"><option value="">Pilih...</option><option value="lurus">Lurus</option><option value="melengkung">Melengkung</option><option value="tebal">Tebal</option><option value="tipis">Tipis</option><option value="naik">Naik</option></select><input type="text" class="character-eyebrow-shape-free mt-1 text-sm" placeholder="Isi sendiri..."></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Bentuk Hidung:</label>
                                <div class="flex dual-input"><select class="character-nose-shape mt-1"><option value="">Pilih...</option><option value="mancung">Mancung</option><option value="pesek">Pesek</option><option value="sedang">Sedang</option><option value="lebar">Lebar</option><option value="bengkok">Bengkok</option></select><input type="text" class="character-nose-shape-free mt-1 text-sm" placeholder="Isi sendiri..."></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Bentuk Bibir:</label>
                                <div class="flex dual-input"><select class="character-lip-shape mt-1"><option value="">Pilih...</option><option value="tipis">Tipis</option><option value="penuh">Penuh</option><option value="hati">Hati</option></select><input type="text" class="character-lip-shape-free mt-1 text-sm" placeholder="Isi sendiri..."></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Gaya Rambut:</label>
                                <div class="flex dual-input"><select class="character-hair-style mt-1"><option value="">Pilih...</option><option value="panjang">Panjang</option><option value="pendek">Pendek</option><option value="ikal">Ikal</option><option value="lurus">Lurus</option><option value="keriting">Keriting</option><option value="bergelombang">Bergelombang</option><option value="botak">Botak</option><option value="cepak">Cepak</option><option value="spike">Spike</option></select><input type="text" class="character-hair-style-free mt-1 text-sm" placeholder="Isi sendiri..."></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600">Warna Rambut:</label>
                                <div class="flex dual-input"><select class="character-hair-color mt-1"><option value="">Pilih...</option><option value="hitam">Hitam</option><option value="coklat">Coklat</option><option value="pirang">Pirang</option><option value="merah">Merah</option><option value="uban">Uban/Abu-abu</option></select><input type="text" class="character-hair-color-free mt-1 text-sm" placeholder="Isi sendiri..."></div>
                            </div>
                             <div>
                                <label class="block text-xs font-medium text-gray-600">Kesan Ekspresi:</label>
                                <div class="flex dual-input"><select class="character-general-expression mt-1"><option value="">Pilih...</option><option value="ramah">Ramah</option><option value="serius">Serius</option><option value="sedih">Sedih</option><option value="senang">Senang</option><option value="marah">Marah</option><option value="kalem">Kalem</option><option value="misterius">Misterius</option></select><input type="text" class="character-general-expression-free mt-1 text-sm" placeholder="Isi sendiri..."></div>
                            </div>
                            <div class="lg:col-span-3">
                                <label class="block text-xs font-medium text-gray-600">Ciri/Keunikan Lainnya:</label>
                                <input type="text" class="character-other-features mt-1" placeholder="Tahi lalat, bekas luka, dll.">
                            </div>
                        </div>
                    </details>
                </div>

                <div class="md:col-span-2"><label class="block text-gray-700 text-sm font-medium mb-2">Pakaian:</label><textarea class="character-clothing" rows="2" placeholder="Contoh: Kemeja flanel merah, celana jeans biru"></textarea></div>
                <div><label class="block text-gray-700 text-sm font-medium mb-2">Gaya:</label><input type="text" class="character-style" placeholder="Contoh: Kasual, Formal"></div>
                <div><label class="block text-gray-700 text-sm font-medium mb-2">Aksesoris:</label><input type="text" class="character-accessories" placeholder="Contoh: Kacamata, Jam tangan"></div>
                <div class="md:col-span-2"><label class="block text-gray-700 text-sm font-medium mb-2">Aksi Utama/Umum:</label><textarea class="character-main-action" rows="2" placeholder="Jelaskan secara naratif aksi atau situasi utama karakter"></textarea></div>
                <div><label class="block text-gray-700 text-sm font-medium mb-2">Pose:</label><input type="text" class="character-pose" placeholder="Contoh: Duduk bersila, Berdiri tegap"></div>
                
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Emosi Umum:</label>
                    <div class="flex dual-input"><select class="character-emotion"><option value="">Pilih...</option><option value="ceria">Ceria</option><option value="sedih">Sedih</option><option value="marah">Marah</option><option value="antusias">Antusias</option><option value="tenang">Tenang</option><option value="penasaran">Penasaran</option><option value="datar">Datar</option></select><input type="text" class="character-emotion-free" placeholder="Atau isi sendiri..."></div>
                </div>

                <div class="md:col-span-2"><label class="block text-gray-700 text-sm font-medium mb-2">Detail Tambahan Karakter:</label><textarea class="character-additional-details" rows="2" placeholder="Contoh: Memiliki bekas luka di pipi"></textarea></div>
                
                <div class="md:col-span-2 mt-4 pt-4 border-t border-gray-300">
                    <button type="button" class="generate-char-prompt-btn btn-secondary w-full">Generate Prompt Karakter Konsisten</button>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Hasil Prompt Karakter Konsisten:</label>
                    <div class="relative">
                        <textarea class="character-generated-prompt prompt-output" rows="4" placeholder="Hasil prompt untuk karakter ini akan muncul di sini..."></textarea>
                        <div class="absolute top-2 right-2 flex flex-col gap-2">
                            <button type="button" class="copy-char-prompt-btn text-gray-500 hover:text-indigo-600" title="Salin Prompt Karakter">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- PRODUCT TEMPLATE -->
    <template id="productTemplate">
        <div class="product-block" data-product-id="">
            <div class="flex justify-between items-center mb-4"><h4 class="font-semibold text-gray-700 text-lg">Produk</h4><button type="button" class="remove-product-btn btn-danger text-xs px-2 py-1">Hapus</button></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-gray-700 text-sm font-medium mb-2">Nama Produk:</label><input type="text" class="product-name" placeholder="Contoh: Sepatu Lari 'Cepat'"></div>
                <div class="md:col-span-2"><label class="block text-gray-700 text-sm font-medium mb-2">Deskripsi Produk:</label><textarea class="product-description" rows="3" placeholder="Jelaskan produk secara umum"></textarea></div>
                <div class="md:col-span-2"><label class="block text-gray-700 text-sm font-medium mb-2">Fitur Utama/Keunggulan:</label><textarea class="product-features" rows="3" placeholder="Contoh: Sol empuk, desain aerodinamis, tahan air"></textarea></div>
                <div class="md:col-span-2"><label class="block text-gray-700 text-sm font-medium mb-2">Penempatan/Penggunaan Produk:</label><textarea class="product-placement" rows="2" placeholder="Contoh: Diletakkan di atas meja, dipakai oleh karakter"></textarea></div>
                
                <div class="md:col-span-2 mt-4 pt-4 border-t border-gray-300">
                    <button type="button" class="generate-product-prompt-btn btn-secondary w-full">Generate Prompt Produk</button>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Hasil Prompt Produk:</label>
                    <div class="relative">
                        <textarea class="product-generated-prompt prompt-output" rows="4" placeholder="Hasil prompt untuk produk ini akan muncul di sini..."></textarea>
                         <div class="absolute top-2 right-2 flex flex-col gap-2">
                            <button type="button" class="copy-product-prompt-btn text-gray-500 hover:text-indigo-600" title="Salin Prompt Produk">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="sceneTemplate">
        <div class="scene-block" data-scene-id="">
             <div class="flex justify-between items-center mb-4"><h4 class="font-semibold text-gray-700 text-lg">Adegan</h4><button type="button" class="remove-scene-btn btn-danger text-xs px-2 py-1">Hapus</button></div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2 relative">
                    <label class="block text-gray-700 text-sm font-medium mb-2">Deskripsi Aksi Adegan:</label>
                    <textarea class="scene-description" rows="3" placeholder="Jelaskan apa yang terjadi di adegan ini."></textarea>
                    <button type="button" class="copy-scene-desc-btn absolute top-0 right-0 mt-2 mr-2 text-gray-400 hover:text-indigo-600" title="Salin Deskripsi Adegan">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                    </button>
                </div>
                
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Pergerakan Kamera:</label>
                    <div class="flex dual-input"><select class="scene-camera-movement"><option value="" selected>Pilih...</option><option value="statis">Statis</option><option value="pan">Pan</option><option value="tilt">Tilt</option><option value="dolly">Dolly</option><option value="zoom">Zoom</option><option value="crane">Crane</option><option value="handheld">Handheld</option><option value="drone">Drone</option><option value="stabil">Stabil</option></select><input type="text" class="scene-camera-movement-free" placeholder="Atau isi sendiri..."></div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Sudut Kamera:</label>
                    <div class="flex dual-input"><select class="scene-camera-angle"><option value="" selected>Pilih...</option><option value="eye-level">Eye-level</option><option value="low-angle">Low Angle</option><option value="high-angle">High Angle</option><option value="dutch-angle">Dutch Angle</option><option value="bird-eye">Bird's Eye</option><option value="worm-eye">Worm's Eye</option></select><input type="text" class="scene-camera-angle-free" placeholder="Atau isi sendiri..."></div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Fokus:</label>
                    <div class="flex dual-input"><select class="scene-camera-focus"><option value="" selected>Pilih...</option><option value="dalam">Dalam</option><option value="dangkal">Dangkal</option><option value="rack-focus">Rack Focus</option></select><input type="text" class="scene-camera-focus-free" placeholder="Atau isi sendiri..."></div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Pencahayaan:</label>
                    <div class="flex dual-input"><select class="scene-lighting"><option value="" selected>Pilih...</option><option value="terang">Terang</option><option value="gelap">Gelap</option><option value="natural">Natural</option><option value="dramatis">Dramatis</option><option value="siluet">Siluet</option><option value="lembut">Lembut</option><option value="keras">Keras</option></select><input type="text" class="scene-lighting-free" placeholder="Atau isi sendiri..."></div>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-medium mb-2">Gradasi Warna:</label>
                    <div class="flex dual-input"><select class="scene-color-grading"><option value="" selected>Pilih...</option><option value="hangat">Hangat</option><option value="dingin">Dingin</option><option value="monokrom">Monokrom</option><option value="vibran">Vibran</option><option value="pastel">Pastel</option><option value="retro">Retro</option></select><input type="text" class="scene-color-grading-free" placeholder="Atau isi sendiri..."></div>
                </div>
                
                <div class="md:col-span-2 mt-4 pt-4 border-t border-gray-300">
                    <details class="bg-white border border-gray-200 rounded-lg p-3">
                        <summary class="font-semibold text-gray-700 cursor-pointer">Detail Audio Adegan (Klik untuk Buka)</summary>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Dialog Adegan:</label>
                                <select class="scene-dialog-type">
                                    <option value="tanpa dialog">Tanpa Dialog</option><option value="informatif">Informatif</option><option value="dialog natural">Dialog Natural</option><option value="monolog">Monolog</option><option value="interview">Wawancara</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Mood Suara Adegan:</label>
                                <select class="scene-mood-sound">
                                    <option value="" selected>Pilih...</option>
                                    <option value="happy">Ceria</option>
                                    <option value="sad">Sedih</option>
                                    <option value="cheerful">Gembira</option>
                                    <option value="angry">Marah</option>
                                    <option value="calm">Tenang</option>
                                    <option value="nervous">Gugup</option>
                                    <option value="enthusiastic">Antusias</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Suara/Musik Adegan:</label>
                                <input type="text" class="scene-sound-music" placeholder="Contoh: Ombak tenang, musik jazz">
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Sertakan dialog dengan teks:</label>
                                <select class="scene-dialog-text">
                                    <option value="TIDAK">TIDAK</option>
                                    <option value="YA">YA</option>
                                </select>
                            </div>
                            <div class="scene-dialog-details hidden md:col-span-2">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-gray-700 text-sm font-medium mb-2">Bahasa Dialog:</label>
                                        <select class="scene-dialog-language"><option value="Indonesia">Indonesia</option><option value="Inggris">Inggris</option></select>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 text-sm font-medium mb-2">Dialek/Aksen (Opsional):</label>
                                        <input type="text" class="scene-dialog-dialect" placeholder="Contoh: British, Jawa, Sunda">
                                    </div>
                                </div>
                                <label class="block text-gray-700 text-sm font-medium mb-2">Karakter Dialog:</label>
                                <select class="scene-dialog-character max-w-xs"></select>
                                <div class="scene-dialog-content-container mt-2"></div>
                                <button type="button" class="generate-dialogue-btn btn-secondary w-full mt-2">✨ Buatkan Dialog</button>
                            </div>
                        </div>
                    </details>
                </div>
                
                <div class="md:col-span-2 mt-4 flex items-center gap-4">
                    <button type="button" class="get-scene-suggestion-btn btn-secondary w-full">✨ Generate Detail Adegan (AI)</button>
                    <div class="scene-loader loader hidden"></div>
                </div>

             </div>
        </div>
    </template>

    <!-- Modals -->
    <div id="myModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><div id="modalMessage" class="text-gray-800 break-words text-left"></div><button class="btn-primary mt-4" onclick="document.getElementById('myModal').style.display = 'none';">OK</button></div></div>
    <div id="welcomeModal" class="modal"><div class="modal-content"><p class="text-black-800 mb-4">Aplikasi ini dibuat oleh PAPAHNYA IBRACOBRA.</p><button id="closeWelcomeBtn" class="btn-primary">OK</button></div></div>
    
    <script>
        // --- UTILITY AND GLOBAL VARIABLES ---
        const getById = (id) => document.getElementById(id);
        let characterCounter = 0;
        let productCounter = 0;
        let sceneCounter = 0;

        // --- DOM ELEMENTS ---
        const apiKeyInput = getById('apiKeyInput');
        const imageUpload = getById('imageUpload'), imagePreviewContainer = getById('image-preview-container'), imagePreview = getById('imagePreview'), generateFromImageBtn = getById('generateFromImageBtn'), imageLoader = getById('image-loader'), imageTarget = getById('imageTarget');
        const mainThemeInput = getById('mainTheme');
        const smartSceneCount = getById('smartSceneCount');
        const getStoryOptionsBtn = getById('getStoryOptionsBtn');
        const developIdeaBtn = getById('developIdeaBtn');
        const smartLoader = getById('smart-loader');
        const generalSubject = getById('generalSubject');
        const videoTypeSelect = getById('videoType');
        const cameraStyleSelect = getById('cameraStyle');
        const cameraStyleFreeInput = getById('cameraStyle-free');
        const addCharacterBtn = getById('addCharacterBtn'), characterInputsContainer = getById('characterInputsContainer'), characterTemplate = getById('characterTemplate');
        const addProductBtn = getById('addProductBtn'), productInputsContainer = getById('productInputsContainer'), productTemplate = getById('productTemplate');
        const locationInput = getById('location');
        const addSceneBtn = getById('addSceneBtn'), sceneInputsContainer = getById('sceneInputsContainer'), sceneTemplate = getById('sceneTemplate');
        const videoQualitySelect = getById('videoQuality'), videoRatioSelect = getById('videoRatio'), additionalDetailsTextarea = getById('additionalDetails'), negativePromptInput = getById('negativePrompt');
        const generateBtn = getById('generateBtn'), clearBtn = getById('clearBtn');
        const exportBtn = getById('exportBtn'), importBtn = getById('importBtn');
        const modal = getById('myModal'), modalMessage = getById('modalMessage'), closeButton = document.querySelector(".close-button"), welcomeModal = getById('welcomeModal'), closeWelcomeBtn = getById('closeWelcomeBtn');
        const storyOptionsDisplayArea = getById('storyOptionsDisplayArea'), storyOptionsContainer = getById('storyOptionsContainer'), storyOptionsLoader = getById('story-options-loader'), closeStoryOptions = getById('closeStoryOptions');
        const getNegativeSuggestionBtn = getById('getNegativeSuggestionBtn');
        const promptIdOutput = getById('promptId');
        const aiFinalCommandInput = getById('aiFinalCommand');
        const executeAiCommandBtn = getById('executeAiCommandBtn');
        const ultimateCommandBtn = getById('ultimateCommandBtn');
        const aiCommandLoader = getById('ai-command-loader');
        const generateBackgroundBtn = getById('generateBackgroundBtn');
        const backgroundLoader = getById('background-loader');


        // --- HELPER FUNCTIONS ---
        const showAlert = (message) => {
            if (!message || typeof message !== 'string' || message.trim() === '') return;
            modalMessage.innerHTML = message;
            modal.style.display = "flex";
        };
        closeButton.onclick = () => modal.style.display = "none";
        closeStoryOptions.onclick = () => storyOptionsDisplayArea.classList.add('hidden');
        
        const parseJsonResponse = (text) => {
            try {
                // First, try to parse it directly
                return JSON.parse(text);
            } catch (e) {
                // If it fails, try to extract JSON from markdown
                const match = text.match(/```json\s*([\s\S]*?)\s*```/);
                if (match && match[1]) {
                    return JSON.parse(match[1]);
                }
                // As a last resort, try to find the first '{' or '[' and the last '}' or ']'
                const firstBracket = text.indexOf('{');
                const firstSquare = text.indexOf('[');
                let start = -1;

                if (firstBracket === -1) start = firstSquare;
                else if (firstSquare === -1) start = firstBracket;
                else start = Math.min(firstBracket, firstSquare);

                if (start !== -1) {
                    const lastBracket = text.lastIndexOf('}');
                    const lastSquare = text.lastIndexOf(']');
                    const end = Math.max(lastBracket, lastSquare);
                    if (end > start) {
                        const jsonString = text.substring(start, end + 1);
                        return JSON.parse(jsonString);
                    }
                }
                // If all else fails, re-throw the original error
                throw e;
            }
        };

        const getDropdownOrFreeTextValue = (baseName, container) => {
            const scope = container || document;
            const freeTextInput = scope.querySelector(`.${baseName}-free, #${baseName}-free`);
            if (freeTextInput && freeTextInput.value.trim()) {
                return freeTextInput.value.trim();
            }
            const dropdown = scope.querySelector(`.${baseName}, #${baseName}`);
            return dropdown ? dropdown.value : '';
        };

        const setDropdownOrFreeTextValue = (baseName, value, container) => {
            const scope = container || document;
            const freeTextInput = scope.querySelector(`.${baseName}-free, #${baseName}-free`);
            const dropdown = scope.querySelector(`.${baseName}, #${baseName}`);
            
            if (!value) return;

            if (dropdown) {
                const optionExists = Array.from(dropdown.options).some(opt => opt.value.toLowerCase() === value.toLowerCase());
                if (optionExists) {
                    dropdown.value = Array.from(dropdown.options).find(opt => opt.value.toLowerCase() === value.toLowerCase()).value;
                } else if (freeTextInput) {
                    freeTextInput.value = value;
                }
            } else if (freeTextInput) {
                 freeTextInput.value = value;
            }
        };

        const updateStyleKeywords = () => {
            const style = getDropdownOrFreeTextValue('cameraStyle');
            const additionalDetails = additionalDetailsTextarea;
            const negativePrompt = negativePromptInput;

            const realismKeywords = "video sinematik realistis, rekaman video nyata, ultra realistis";
            const antiAnimationKeywords = "animasi, kartun, 3D, lukisan";
            const antiRealismKeywords = "realistis, foto, nyata";

            const removeKeywords = (text, keywords) => {
                let newText = ` ${text} `;
                keywords.split(', ').forEach(kw => {
                    const regex = new RegExp(`\\s*,?\\s*${kw}\\s*,?\\s*`, 'gi');
                    newText = newText.replace(regex, ' ');
                });
                return newText.replace(/ , /g, ', ').replace(/, ,/g, ',').trim().replace(/^,|,$/g, '').trim();
            };
            
            let currentDetails = removeKeywords(additionalDetails.value, realismKeywords);
            let currentNegative = removeKeywords(negativePrompt.value, antiAnimationKeywords);
            currentNegative = removeKeywords(currentNegative, antiRealismKeywords);

            if (style === 'Realistis') {
                if (currentDetails) currentDetails += ", ";
                additionalDetails.value = currentDetails + realismKeywords;
                
                if (currentNegative) currentNegative += ", ";
                negativePrompt.value = currentNegative + antiAnimationKeywords;

            } else if (style) { 
                if (currentNegative) currentNegative += ", ";
                negativePrompt.value = currentNegative + antiRealismKeywords;
                additionalDetails.value = currentDetails;
            } else { 
                 additionalDetails.value = currentDetails;
                 negativePrompt.value = currentNegative;
            }
        };
        
        async function callGeminiAPI(contentsPayload, isJsonOutput = true) {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showAlert("<p>API Key Google AI diperlukan.</p>");
                return null;
            }
            
            const payload = {
                contents: contentsPayload,
            };

            if (isJsonOutput) {
                payload.generationConfig = { response_mime_type: "application/json" };
            }

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorMessage = `API error: ${response.status}`;
                    try {
                        const errorBody = await response.json();
                        if (errorBody.error && errorBody.error.message) {
                            errorMessage += ` - ${errorBody.error.message}`;
                        }
                    } catch (e) {
                         errorMessage += ` ${response.statusText}`;
                    }
                     if (response.status === 503) {
                        errorMessage = "Layanan AI sementara tidak tersedia (Error 503). Mohon coba lagi dalam beberapa saat.";
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else if (result.promptFeedback && result.promptFeedback.blockReason) {
                     throw new Error(`Permintaan diblokir karena: ${result.promptFeedback.blockReason}`);
                }
                else {
                    console.error("Unexpected API response structure:", result);
                    throw new Error("Respons API tidak valid atau strukturnya tidak terduga.");
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                showAlert(`<p>Terjadi kesalahan saat menghubungi AI: ${error.message}</p>`);
                return null;
            }
        }


        // --- NEW INTEGRATED SMART GENERATOR ---
        const getStoryOptions = async () => {
            const idea = mainThemeInput.value.trim();
            const scenes = smartSceneCount.value;
            const visualStyle = videoTypeSelect.value;
            const videoStyle = getDropdownOrFreeTextValue('cameraStyle');
            const mood = getDropdownOrFreeTextValue('videoMood');

            smartLoader.classList.remove('hidden');
            getStoryOptionsBtn.disabled = true;
            developIdeaBtn.disabled = true;

            storyOptionsDisplayArea.classList.remove('hidden');
            storyOptionsContainer.innerHTML = '';
            storyOptionsLoader.classList.remove('hidden');

            const promptToAI = `Anda adalah seorang brainstormer kreatif dan penulis naskah. Berdasarkan bahan dasar berikut, kembangkan 5 opsi cerita yang unik dan menarik.

Bahan Dasar:
- Ide Awal: "${idea}" (Jika kosong, buat dari nol berdasarkan parameter lain)
- Jumlah Adegan: ${scenes}
- Gaya Visual: ${visualStyle || 'tidak spesifik'}
- Gaya Video: ${videoStyle || 'tidak spesifik'}
- Suasana: ${mood || 'tidak spesifik'}

Setiap opsi cerita harus berupa paragraf singkat yang deskriptif dan imajinatif. Kembalikan hasilnya dalam format JSON array yang valid berisi 5 string.
Contoh: ["cerita 1...", "cerita 2...", "cerita 3...", "cerita 4...", "cerita 5..."]`;

            const contentsPayload = [{ parts: [{ text: promptToAI }] }];
            const responseText = await callGeminiAPI(contentsPayload);

            if (responseText) {
                try {
                    const options = parseJsonResponse(responseText);
                    storyOptionsContainer.innerHTML = '';
                    options.forEach(optionText => {
                        const div = document.createElement('div');
                        div.className = 'story-option';
                        div.textContent = optionText;
                        div.onclick = () => {
                            mainThemeInput.value = optionText;
                            storyOptionsDisplayArea.classList.add('hidden');
                        };
                        storyOptionsContainer.appendChild(div);
                    });
                } catch (error) {
                     console.error("Get Story Options JSON Parse Error:", error);
                     storyOptionsContainer.innerHTML = `<p class="text-red-500">Gagal memproses respons AI: ${error.message}</p>`;
                }
            }
            
            smartLoader.classList.add('hidden');
            storyOptionsLoader.classList.add('hidden');
            getStoryOptionsBtn.disabled = false;
            developIdeaBtn.disabled = false;
        };

        const developIdeaIntoDetails = async () => {
            const idea = mainThemeInput.value.trim();
            if (!idea) { showAlert("<p>Mohon isi 'Ide Pokok' untuk dikembangkan.</p>"); return; }
            
            const scenes = smartSceneCount.value;
            const visualStyle = videoTypeSelect.value;
            const videoStyle = getDropdownOrFreeTextValue('cameraStyle');
            const mood = getDropdownOrFreeTextValue('videoMood');

            smartLoader.classList.remove('hidden');
            getStoryOptionsBtn.disabled = true;
            developIdeaBtn.disabled = true;

            const promptToAI = `Anda adalah penulis naskah AI berbahasa Indonesia. Berdasarkan ide ini: "${idea}", dan spesifikasi: Gaya Visual: ${visualStyle}, Gaya Video: ${videoStyle}, Suasana: ${mood}, Jumlah Adegan: ${scenes}.
Tugas Anda adalah mengisi detail untuk sebuah video. Buatlah deskripsi untuk karakter, produk (jika relevan), latar, dan rangkaian adegan.
PENTING: Semua nilai dalam JSON harus dalam Bahasa Indonesia.
Kembalikan hasilnya sebagai satu objek JSON yang valid dengan struktur berikut:
{
  "characters": [ { "name": "...", "race": "...", "age": "...", "body_shape": "...", "clothing": "...", "main_action": "...", "emotion": "..." } ],
  "products": [ { "name": "...", "description": "...", "features": "...", "placement": "..." } ],
  "background": { "location": "...", "time": "...", "weather": "...", "season": "..." },
  "scenes": [ { "description": "...", "camera_movement": "...", "camera_angle": "..." } ]
}
Pastikan jumlah adegan sesuai permintaan. Jika tidak ada produk yang relevan, kembalikan array 'products' yang kosong.`;

            const contentsPayload = [{ parts: [{ text: promptToAI }] }];
            const responseText = await callGeminiAPI(contentsPayload);

            if (responseText) {
                 try {
                    const data = parseJsonResponse(responseText);
                    
                    // Clear existing details
                    characterInputsContainer.innerHTML = ''; characterCounter = 0;
                    productInputsContainer.innerHTML = ''; productCounter = 0;
                    sceneInputsContainer.innerHTML = ''; sceneCounter = 0;

                    // Populate Characters
                    if (data.characters && data.characters.length > 0) {
                        data.characters.forEach(char => {
                            const newBlock = addCharacter();
                            newBlock.querySelector('.character-name').value = char.name || '';
                            newBlock.querySelector('.character-race').value = char.race || '';
                            newBlock.querySelector('.character-age').value = char.age || '';
                            newBlock.querySelector('.character-body-shape').value = char.body_shape || '';
                            newBlock.querySelector('.character-clothing').value = char.clothing || '';
                            newBlock.querySelector('.character-main-action').value = char.main_action || '';
                            setDropdownOrFreeTextValue('character-emotion', char.emotion, newBlock);
                        });
                    } else { addCharacter(); }

                    // Populate Products
                    if (data.products && data.products.length > 0) {
                        data.products.forEach(prod => {
                            const newBlock = addProduct();
                            newBlock.querySelector('.product-name').value = prod.name || '';
                            newBlock.querySelector('.product-description').value = prod.description || '';
                            newBlock.querySelector('.product-features').value = prod.features || '';
                            newBlock.querySelector('.product-placement').value = prod.placement || '';
                        });
                    } else { addProduct(); }

                    // Populate Background
                    if (data.background) {
                        locationInput.value = data.background.location || '';
                        setDropdownOrFreeTextValue('time', data.background.time);
                        setDropdownOrFreeTextValue('weather', data.background.weather);
                        setDropdownOrFreeTextValue('season', data.background.season);
                    }

                    // Populate Scenes
                    if (data.scenes && data.scenes.length > 0) {
                        data.scenes.forEach(scene => {
                            const newBlock = addScene();
                            newBlock.querySelector('.scene-description').value = scene.description || '';
                            setDropdownOrFreeTextValue('scene-camera-movement', scene.camera_movement, newBlock);
                            setDropdownOrFreeTextValue('scene-camera-angle', scene.camera_angle, newBlock);
                        });
                    } else { addScene(); }

                    showAlert("<p>Semua kolom detail telah diisi secara otomatis berdasarkan ide Anda. Silakan tinjau dan sesuaikan jika perlu.</p>");
                } catch (error) {
                    console.error("Develop Idea JSON Parse Error:", error);
                    showAlert(`<p>Gagal memproses respons AI: ${error.message}</p>`);
                }
            }
            
            smartLoader.classList.add('hidden');
            getStoryOptionsBtn.disabled = false;
            developIdeaBtn.disabled = false;
        };

        // --- IMAGE-BASED GENERATION (Hybrid) ---
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { imagePreview.src = e.target.result; imagePreviewContainer.classList.remove('hidden'); generateFromImageBtn.disabled = false; };
                reader.readAsDataURL(file);
            } else { imagePreviewContainer.classList.add('hidden'); generateFromImageBtn.disabled = true; }
        });

        generateFromImageBtn.addEventListener('click', () => {
            const file = imageUpload.files[0];
            const targetId = imageTarget.value;
            const targetType = imageTarget.options[imageTarget.selectedIndex]?.dataset.type;
            
            if (!file) { showAlert("<p>Silakan pilih file gambar.</p>"); return; }
            
            imageLoader.classList.remove('hidden');
            generateFromImageBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64ImageData = e.target.result.split(',')[1];
                
                const prompt = `Analisis gambar ini secara komprehensif. Identifikasi SEMUA karakter, latar, dan produk yang mungkin ada. Kembalikan hasilnya sebagai objek JSON tunggal.
PENTING: Semua nilai dalam JSON harus dalam Bahasa Indonesia. Jika suatu detail tidak dapat ditemukan atau tidak relevan, kembalikan string kosong (""), JANGAN menulis 'tidak ada' atau 'tidak dapat ditentukan'.

Struktur JSON yang harus Anda hasilkan:
{
  "subjek_umum": "Deskripsi umum dari seluruh gambar.",
  "latar_umum": { "lokasi": "Deskripsikan lokasi dengan sangat detail dan kaya. Sebutkan objek-objek penting, tekstur, kondisi pencahayaan, dan suasana keseluruhan dari tempat tersebut.", "waktu": "...", "cuaca": "...", "musim": "..." },
  "produk_terdeteksi": { "nama_produk": "...", "deskripsi_produk": "...", "fitur_utama": "...", "penempatan_produk": "..." },
  "karakter_terdeteksi": [
    {
      "nama": "Karakter 1 (misal: Ayah, Pria Dewasa)", "ras": "...", "perkiraan_usia": "...", "bentuk_tubuh": "...", "perkiraan_tinggi": "...", "kewarganegaraan": "...", "pakaian": "...", "gaya": "...", "aksesoris": "...", "aksi_utama": "...", "pose": "...", "emosi": "...", "detail_tambahan": "...",
      "detail_wajah": {"bentuk_wajah": "...", "warna_mata": "...", "bentuk_mata": "...", "bentuk_alis": "...", "bentuk_hidung": "...", "bentuk_bibir": "...", "gaya_rambut": "...", "warna_rambut": "...", "kesan_ekspresi": "...", "ciri_khas_lain": "..."}
    }
  ]
}
Aturan:
- Jika tidak ada karakter, kembalikan array 'karakter_terdeteksi' yang kosong.
- Jika tidak ada produk yang jelas, kembalikan objek 'produk_terdeteksi' dengan nilai kosong.
- Berikan deskripsi yang berbeda dan spesifik untuk setiap karakter yang ditemukan.`;
                
                const contentsPayload = [{ parts: [ { text: prompt }, { inline_data: { mime_type: file.type, data: base64ImageData } } ] }];
                const responseText = await callGeminiAPI(contentsPayload);

                if(responseText){
                    try {
                        const data = parseJsonResponse(responseText);
                        let messages = [];
                        
                        generalSubject.value = data.subjek_umum || '';

                        if (!targetType) {
                            characterInputsContainer.innerHTML = '';
                            characterCounter = 0;
                            if (data.karakter_terdeteksi && Array.isArray(data.karakter_terdeteksi) && data.karakter_terdeteksi.length > 0) {
                                data.karakter_terdeteksi.forEach(charData => {
                                    const newBlock = addCharacter(false);
                                    fillCharacterBlock(newBlock, charData);
                                });
                                messages.push(`${data.karakter_terdeteksi.length} karakter berhasil dideteksi.`);
                            } else {
                                addCharacter(false);
                                messages.push("Tidak ada karakter yang terdeteksi.");
                            }
                        }

                        if (targetType === 'location' && data.latar_umum) {
                            locationInput.value = data.latar_umum.lokasi || '';
                            setDropdownOrFreeTextValue('time', data.latar_umum.waktu);
                            setDropdownOrFreeTextValue('weather', data.latar_umum.cuaca);
                            setDropdownOrFreeTextValue('season', data.latar_umum.musim);
                            messages.push('Detail Latar berhasil diisi.');
                        } else if (targetType === 'product' && data.produk_terdeteksi) {
                            const targetBlock = document.querySelector(`.product-block[data-product-id="${targetId}"]`);
                            if (targetBlock) {
                                targetBlock.querySelector('.product-name').value = data.produk_terdeteksi.nama_produk || '';
                                targetBlock.querySelector('.product-description').value = data.produk_terdeteksi.deskripsi_produk || '';
                                targetBlock.querySelector('.product-features').value = data.produk_terdeteksi.fitur_utama || '';
                                targetBlock.querySelector('.product-placement').value = data.produk_terdeteksi.penempatan_produk || '';
                                messages.push('Detail Produk berhasil diisi.');
                            }
                        } else if (targetType === 'character') {
                             const targetBlock = document.querySelector(`.character-block[data-character-id="${targetId}"]`);
                             if(targetBlock && data.karakter_terdeteksi && data.karakter_terdeteksi.length > 0){
                                 fillCharacterBlock(targetBlock, data.karakter_terdeteksi[0]);
                                 messages.push(`Detail untuk ${targetBlock.querySelector('.character-name').value} berhasil diisi.`);
                             }
                        }
                        
                        showAlert(messages.join('<br>'));
                        updateAllDropdowns();

                    } catch (error) {
                        console.error("Image Gen Parse Error:", error);
                        showAlert(`<p>Gagal memproses respons AI dari gambar: ${error.message}</p>`);
                    }
                }
                imageLoader.classList.add('hidden');
                generateFromImageBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        });

        function fillCharacterBlock(block, data) {
            if (!block || !data) return;
            block.querySelector('.character-name').value = data.nama || data['character-name'] || `Karakter ${block.dataset.characterId}`;
            block.querySelector('.character-race').value = data.ras || data['character-race'] || '';
            block.querySelector('.character-age').value = data.perkiraan_usia || data['character-age'] || '';
            block.querySelector('.character-body-shape').value = data.bentuk_tubuh || data['character-body-shape'] || '';
            block.querySelector('.character-height').value = data.perkiraan_tinggi || data['character-height'] || '';
            block.querySelector('.character-nationality').value = data.kewarganegaraan || data['character-nationality'] || '';
            block.querySelector('.character-clothing').value = data.pakaian || data['character-clothing'] || '';
            block.querySelector('.character-style').value = data.gaya || data['character-style'] || '';
            block.querySelector('.character-accessories').value = data.aksesoris || data['character-accessories'] || '';
            block.querySelector('.character-main-action').value = data.aksi_utama || data['character-main-action'] || '';
            block.querySelector('.character-pose').value = data.pose || data['character-pose'] || '';
            block.querySelector('.character-additional-details').value = data.detail_tambahan || data['character-additional-details'] || '';
            
            setDropdownOrFreeTextValue('character-emotion', data.emosi || data['character-emotion'] || data['character-emotion-free'], block);
            
            const faceData = data.detail_wajah || data;
            
            setDropdownOrFreeTextValue('character-face-shape', faceData.bentuk_wajah || faceData['character-face-shape'] || faceData['character-face-shape-free'], block);
            setDropdownOrFreeTextValue('character-eye-color', faceData.warna_mata || faceData['character-eye-color'] || faceData['character-eye-color-free'], block);
            setDropdownOrFreeTextValue('character-eye-shape', faceData.bentuk_mata || faceData['character-eye-shape'] || faceData['character-eye-shape-free'], block);
            setDropdownOrFreeTextValue('character-eyebrow-shape', faceData.bentuk_alis || faceData['character-eyebrow-shape'] || faceData['character-eyebrow-shape-free'], block);
            setDropdownOrFreeTextValue('character-nose-shape', faceData.bentuk_hidung || faceData['character-nose-shape'] || faceData['character-nose-shape-free'], block);
            setDropdownOrFreeTextValue('character-lip-shape', faceData.bentuk_bibir || faceData['character-lip-shape'] || faceData['character-lip-shape-free'], block);
            setDropdownOrFreeTextValue('character-hair-style', faceData.gaya_rambut || faceData['character-hair-style'] || faceData['character-hair-style-free'], block);
            setDropdownOrFreeTextValue('character-hair-color', faceData.warna_rambut || faceData['character-hair-color'] || faceData['character-hair-color-free'], block);
            setDropdownOrFreeTextValue('character-general-expression', faceData.kesan_ekspresi || faceData['character-general-expression'] || faceData['character-general-expression-free'], block);
            block.querySelector('.character-other-features').value = faceData.ciri_khas_lain || faceData['character-other-features'] || '';
        }

        // --- CHARACTER & PRODUCT FUNCTIONS ---
        const generateCharacterPrompt = (characterBlock) => {
            const outputTextarea = characterBlock.querySelector('.character-generated-prompt');
            const getFeatureValue = (featureName) => getDropdownOrFreeTextValue(`character-${featureName}`, characterBlock);
            const parts = [];
            const name = characterBlock.querySelector('.character-name').value.trim();
            parts.push(name || "seorang karakter");
            const race = characterBlock.querySelector('.character-race').value.trim();
            if(race) parts.push(race);
            const age = characterBlock.querySelector('.character-age').value.trim();
            if(age) parts.push(`berusia ${age}`);
            const nationality = characterBlock.querySelector('.character-nationality').value.trim();
            if(nationality) parts.push(`berkewarganegaraan ${nationality}`);
            const bodyShape = characterBlock.querySelector('.character-body-shape').value.trim();
            const height = characterBlock.querySelector('.character-height').value.trim();
            if(bodyShape || height) {
                let physicalDesc = 'dengan';
                if(bodyShape) physicalDesc += ` bentuk tubuh ${bodyShape}`;
                if(bodyShape && height) physicalDesc += ' dan';
                if(height) physicalDesc += ` tinggi sekitar ${height}`;
                parts.push(physicalDesc);
            }
            let faceParts = [];
            const faceShape = getFeatureValue('face-shape'); if (faceShape) faceParts.push(`wajah ${faceShape}`);
            const eyeColor = getFeatureValue('eye-color'); if (eyeColor) faceParts.push(`mata berwarna ${eyeColor}`);
            const eyeShape = getFeatureValue('eye-shape'); if (eyeShape) faceParts.push(`mata berbentuk ${eyeShape}`);
            const eyebrowShape = getFeatureValue('eyebrow-shape'); if (eyebrowShape) faceParts.push(`alis ${eyebrowShape}`);
            const noseShape = getFeatureValue('nose-shape'); if (noseShape) faceParts.push(`hidung ${noseShape}`);
            const lipShape = getFeatureValue('lip-shape'); if (lipShape) faceParts.push(`bibir ${lipShape}`);
            if(faceParts.length > 0) parts.push(`Detail wajahnya meliputi ${faceParts.join(', ')}`);
            let hairParts = [];
            const hairStyle = getFeatureValue('hair-style'); if(hairStyle) hairParts.push(hairStyle);
            const hairColor = getFeatureValue('hair-color'); if(hairColor) hairParts.push(`berwarna ${hairColor}`);
            if (hairParts.length > 0) parts.push(`Rambutnya ${hairParts.join(' ')}`);
            const generalExpression = getFeatureValue('general-expression'); 
            if(generalExpression) parts.push(`Memiliki kesan ekspresi ${generalExpression}`);
            const otherFeatures = characterBlock.querySelector('.character-other-features').value.trim();
            if(otherFeatures) parts.push(`Ciri khas lainnya adalah ${otherFeatures}`);
            const clothing = characterBlock.querySelector('.character-clothing').value.trim();
            if (clothing) parts.push(`Mengenakan ${clothing}`);
            const style = characterBlock.querySelector('.character-style').value.trim();
            if (style) parts.push(`Gayanya ${style}`);
            const accessories = characterBlock.querySelector('.character-accessories').value.trim();
            if(accessories) parts.push(`Dilengkapi dengan aksesoris ${accessories}`);
            const mainAction = characterBlock.querySelector('.character-main-action').value.trim();
            if(mainAction) parts.push(`Dia sedang ${mainAction}`);
            const pose = characterBlock.querySelector('.character-pose').value.trim();
            if(pose) parts.push(`Posenya adalah ${pose}`);
            const emotion = getDropdownOrFreeTextValue('character-emotion', characterBlock);
            if (emotion) parts.push(`Emosi yang ditunjukkan adalah ${emotion}`);
            const additionalDetails = characterBlock.querySelector('.character-additional-details').value.trim();
            if(additionalDetails) parts.push(`Detail tambahan: ${additionalDetails}`);
            outputTextarea.value = parts.filter(Boolean).map(p => p.endsWith('.') ? p : p + '.').join(' ');
            showAlert("<p>Prompt karakter konsisten berhasil dibuat.</p>");
        };

        const addCharacter = (updateDD = true) => {
            characterCounter++;
            const clone = characterTemplate.content.cloneNode(true);
            const block = clone.querySelector('.character-block');
            block.dataset.characterId = characterCounter;
            block.querySelector('h4').textContent = `Karakter ${characterCounter}`;
            block.querySelector('.character-name').addEventListener('input', updateAllDropdowns);
            block.querySelector('.remove-character-btn').onclick = () => { block.remove(); updateAllDropdowns(); };
            block.querySelector('.generate-char-prompt-btn').addEventListener('click', () => generateCharacterPrompt(block));
            block.querySelector('.copy-char-prompt-btn').addEventListener('click', () => {
                 const output = block.querySelector('.character-generated-prompt');
                 if(output.value) { 
                    const temp = document.createElement('textarea');
                    document.body.appendChild(temp);
                    temp.value = output.value;
                    temp.select();
                    document.execCommand('copy');
                    document.body.removeChild(temp);
                    showAlert('<p>Prompt karakter disalin!</p>'); 
                 }
            });
            characterInputsContainer.appendChild(clone);
            if(updateDD) updateAllDropdowns();
            return block;
        };

        const generateProductPrompt = (productBlock) => {
            const outputTextarea = productBlock.querySelector('.product-generated-prompt');
            const name = productBlock.querySelector('.product-name').value.trim();
            const desc = productBlock.querySelector('.product-description').value.trim();
            const features = productBlock.querySelector('.product-features').value.trim();
            const placement = productBlock.querySelector('.product-placement').value.trim();
            
            if (!name) {
                showAlert("<p>Nama produk wajib diisi.</p>");
                return;
            }

            let parts = [`Produk utama adalah ${name}.`];
            if(desc) parts.push(desc);
            if(features) parts.push(`Fitur utamanya adalah: ${features}.`);
            if(placement) parts.push(`Dalam adegan, produk ini ${placement}.`);

            outputTextarea.value = parts.join(' ');
            showAlert("<p>Prompt produk berhasil dibuat.</p>");
        };

        const addProduct = (updateDD = true) => {
            productCounter++;
            const clone = productTemplate.content.cloneNode(true);
            const block = clone.querySelector('.product-block');
            block.dataset.productId = productCounter;
            block.querySelector('h4').textContent = `Produk ${productCounter}`;
            block.querySelector('.product-name').addEventListener('input', updateAllDropdowns);
            block.querySelector('.remove-product-btn').onclick = () => { block.remove(); updateAllDropdowns(); };
            block.querySelector('.generate-product-prompt-btn').addEventListener('click', () => generateProductPrompt(block));
            block.querySelector('.copy-product-prompt-btn').addEventListener('click', () => {
                 const output = block.querySelector('.product-generated-prompt');
                 if(output.value) { 
                    const temp = document.createElement('textarea');
                    document.body.appendChild(temp);
                    temp.value = output.value;
                    temp.select();
                    document.execCommand('copy');
                    document.body.removeChild(temp);
                    showAlert('<p>Prompt produk disalin!</p>'); 
                 }
            });
            productInputsContainer.appendChild(clone);
            if(updateDD) updateAllDropdowns();
            return block;
        };

        // --- SCENE & BACKGROUND FUNCTIONS ---
        const generateCreativeBackground = async () => {
            const locationIdea = locationInput.value.trim();
            if (!locationIdea) { showAlert("<p>Mohon isi ide awal di kolom 'Lokasi' untuk memulai.</p>"); return; }

            backgroundLoader.classList.remove('hidden');
            generateBackgroundBtn.disabled = true;

            const prompt = `Anda adalah seorang penulis deskriptif berbahasa Indonesia. Berdasarkan ide lokasi ini: "${locationIdea}", kembangkan menjadi deskripsi yang kaya dan sinematik. Juga, sarankan waktu, cuaca, dan musim yang paling cocok. PENTING: Semua nilai dalam JSON harus dalam Bahasa Indonesia. Kembalikan dalam format JSON: {"lokasi_kreatif": "...", "waktu": "...", "cuaca": "...", "musim": "..."}`;
            const contentsPayload = [{ parts: [{ text: prompt }] }];
            const responseText = await callGeminiAPI(contentsPayload);

            if (responseText) {
                try {
                    const data = parseJsonResponse(responseText);
                    locationInput.value = data.lokasi_kreatif || locationIdea;
                    setDropdownOrFreeTextValue('time', data.waktu);
                    setDropdownOrFreeTextValue('weather', data.cuaca);
                    setDropdownOrFreeTextValue('season', data.musim);
                    showAlert("<p>Latar berhasil dibuat dan diisi.</p>");
                } catch (error) {
                    console.error("Generate Background Error:", error);
                    showAlert(`<p>Gagal memproses respons AI: ${error.message}</p>`);
                }
            }
            backgroundLoader.classList.add('hidden');
            generateBackgroundBtn.disabled = false;
        };

        const getAudioDetailsForScene = (sceneBlock) => {
            let audioDetailsId = '';
            let hasAudioInfo = false;
            if (sceneBlock.querySelector('.scene-dialog-type').value !== 'tanpa dialog') {
                const lang = sceneBlock.querySelector('.scene-dialog-language').value;
                const langIndicator = lang === 'Indonesia' ? '(ID)' : '(ENG)';
                const dialect = sceneBlock.querySelector('.scene-dialog-dialect').value.trim();
                let dialogContentId = '';
                const allDialogs = [];
                sceneBlock.querySelectorAll('.dialog-content-block').forEach(dialogBlock => {
                    const textarea = dialogBlock.querySelector('.dialog-content-textarea');
                    if (textarea.value.trim()) {
                        const label = dialogBlock.querySelector('label').textContent;
                        const charName = label.replace('Dialog ', '').replace(':', '').trim();
                        allDialogs.push(`${charName} berkata: "${textarea.value.trim()}"`);
                    }
                });
                if(allDialogs.length > 0) {
                    dialogContentId = ` Isi dialog: ${allDialogs.join('; ')}.`;
                    hasAudioInfo = true;
                }
                audioDetailsId += `Dialog ${sceneBlock.querySelector('.scene-dialog-type').value} ${langIndicator}, diucapkan dalam bahasa ${lang}${dialect ? ` dengan dialek/aksen ${dialect}` : ''}.${dialogContentId}`;
            }
            const soundMusic = sceneBlock.querySelector('.scene-sound-music').value.trim();
            if(soundMusic){
                 audioDetailsId += ` Suara/Musik: ${soundMusic}.`;
                 hasAudioInfo = true;
            }
            const moodSound = sceneBlock.querySelector('.scene-mood-sound').value;
            if(moodSound && sceneBlock.querySelector('.scene-dialog-type').value !== 'tanpa dialog'){
                audioDetailsId += ` Mood suara ${moodSound}.`;
                hasAudioInfo = true;
            }
            if (sceneBlock.querySelector('.scene-dialog-text').value === 'YA') {
                audioDetailsId += ' Sertakan dialog sebagai teks (subtitle) di layar.';
                hasAudioInfo = true;
            }
            return hasAudioInfo ? `Audio: ${audioDetailsId}` : 'Audio: Tanpa dialog atau suara spesifik.';
        };

        const getCreativeSceneSuggestion = async (sceneBlock) => {
            const loader = sceneBlock.querySelector('.scene-loader');
            const getSuggestionBtn = sceneBlock.querySelector('.get-scene-suggestion-btn');
            const sceneDescriptionInput = sceneBlock.querySelector('.scene-description');
            const sceneDescription = sceneDescriptionInput.value.trim();

            if (!sceneDescription) { showAlert("<p>Mohon isi deskripsi adegan.</p>"); return; }

            loader.classList.remove('hidden');
            getSuggestionBtn.disabled = true;
            
            const dialogueContext = getAudioDetailsForScene(sceneBlock);
            const charactersContext = Array.from(document.querySelectorAll('.character-generated-prompt')).map(b => b.value.trim()).filter(p => p).join('; ');
            const productsContext = Array.from(document.querySelectorAll('.product-generated-prompt')).map(b => b.value.trim()).filter(p => p).join('; ');
            const backgroundContext = `Berlatar di ${locationInput.value.trim()} pada ${getDropdownOrFreeTextValue('time')}, cuaca ${getDropdownOrFreeTextValue('weather')}, musim ${getDropdownOrFreeTextValue('season')}.`;
            const prompt = `Anda adalah sinematografer berbahasa Indonesia. Berdasarkan konteks cerita berikut:\n\n[Karakter]: ${charactersContext || 'Tidak ada'}\n[Produk]: ${productsContext || 'Tidak ada'}\n[Latar]: ${backgroundContext}\n[Audio & Dialog]: ${dialogueContext}\n\nDan deskripsi adegan awal ini: \"${sceneDescription}\"\n\nTugas Anda adalah:\n1. Kembangkan deskripsi adegan menjadi lebih sinematik, dengan mempertimbangkan dialog yang ada.\n2. Sarankan teknis kamera (pergerakan, sudut, fokus, pencahayaan, gradasi) yang sesuai dengan aksi dan dialog.\n\nPENTING: Semua nilai dalam JSON harus dalam Bahasa Indonesia.\nKembalikan dalam format JSON: {\"deskripsi_kreatif\": \"...\", \"saran_kamera\": {\"pergerakan\": \"...\", \"sudut\": \"...\", \"fokus\": \"...\", \"pencahayaan\": \"...\", \"gradasi\": \"...\"}}`;
            
            const contentsPayload = [{ parts: [{ text: prompt }] }];
            const responseText = await callGeminiAPI(contentsPayload);

            if (responseText) {
                try {
                    const parsedResult = parseJsonResponse(responseText);
                    const audioDetailsText = getAudioDetailsForScene(sceneBlock);
                    sceneDescriptionInput.value = (parsedResult.deskripsi_kreatif || sceneDescription) + `\n\n${audioDetailsText}`;

                    const suggestions = parsedResult.saran_kamera || {};
                    setDropdownOrFreeTextValue('scene-camera-movement', suggestions.pergerakan, sceneBlock);
                    setDropdownOrFreeTextValue('scene-camera-angle', suggestions.sudut, sceneBlock);
                    setDropdownOrFreeTextValue('scene-camera-focus', suggestions.fokus, sceneBlock);
                    setDropdownOrFreeTextValue('scene-lighting', suggestions.pencahayaan, sceneBlock);
                    setDropdownOrFreeTextValue('scene-color-grading', suggestions.gradasi, sceneBlock);
                    
                    showAlert("<p>Rekomendasi adegan berhasil dibuat dan diterapkan.</p>");
                } catch (error) {
                    console.error("Scene Suggestion Parse Error:", error);
                    showAlert(`<p>Gagal memproses respons AI: ${error.message}</p>`);
                }
            }
             
            loader.classList.add('hidden'); 
            getSuggestionBtn.disabled = false; 
        };

        const addScene = (updateDD = true) => {
            sceneCounter++;
            const clone = sceneTemplate.content.cloneNode(true);
            const block = clone.querySelector('.scene-block');
            block.dataset.sceneId = sceneCounter;
            block.querySelector('h4').textContent = `Adegan ${sceneCounter}`;
            block.querySelector('.remove-scene-btn').onclick = () => block.remove();
            block.querySelector('.get-scene-suggestion-btn').addEventListener('click', () => getCreativeSceneSuggestion(block));
            block.querySelector('.generate-dialogue-btn').addEventListener('click', () => generateDialogue(block));
            block.querySelector('.copy-scene-desc-btn').addEventListener('click', (e) => {
                const textarea = e.currentTarget.previousElementSibling;
                if (textarea.value) {
                    textarea.select();
                    document.execCommand('copy');
                    showAlert('<p>Deskripsi adegan disalin!</p>');
                }
            });
            updateSceneDialogOptions(block);
            block.querySelector('.scene-dialog-type').addEventListener('change', () => updateSceneDialogOptions(block));
            block.querySelector('.scene-dialog-character').addEventListener('change', () => updateSceneDialogContent(block));
            sceneInputsContainer.appendChild(clone);
            if(updateDD) updateAllDropdowns();
            return block;
        };
        
        // --- UI & PROMPT FUNCTIONS ---
        const updateAllDropdowns = () => {
            const characters = Array.from(document.querySelectorAll('.character-block')).map(b => ({id: b.dataset.characterId, name: b.querySelector('.character-name').value.trim() || `Karakter ${b.dataset.characterId}`}));
            const products = Array.from(document.querySelectorAll('.product-block')).map(b => ({id: b.dataset.productId, name: b.querySelector('.product-name').value.trim() || `Produk ${b.dataset.productId}`}));
            updateImageTargetDropdown(characters, products);
            document.querySelectorAll('.scene-block').forEach(scene => updateSceneDialogOptions(scene));
        };
        
        const updateImageTargetDropdown = (characters, products) => {
            const selectedValue = imageTarget.value;
            imageTarget.innerHTML = '<option value="">Pilih...</option><option value="location" data-type="location">Latar/Lokasi Umum</option>';
            if (characters.length > 0) {
                imageTarget.innerHTML += characters.map(char => `<option value="${char.id}" data-type="character">${char.name}</option>`).join('');
            }
            if (products.length > 0) {
                imageTarget.innerHTML += products.map(prod => `<option value="${prod.id}" data-type="product">${prod.name}</option>`).join('');
            }
            if (selectedValue && Array.from(imageTarget.options).some(opt => opt.value === selectedValue)) {
                imageTarget.value = selectedValue;
            }
        };

        const updateSceneDialogOptions = (sceneBlock) => {
            const dialogDetails = sceneBlock.querySelector('.scene-dialog-details');
            if (sceneBlock.querySelector('.scene-dialog-type').value !== "tanpa dialog") {
                dialogDetails.classList.remove('hidden');
                const charSelect = sceneBlock.querySelector('.scene-dialog-character');
                const characters = Array.from(document.querySelectorAll('.character-block')).map(b => ({id: b.dataset.characterId, name: b.querySelector('.character-name').value.trim() || `Karakter ${b.dataset.characterId}`}));
                const selectedVal = charSelect.value;
                charSelect.innerHTML = '<option value="all">Dialog Bersama</option><option value="narrator">Narator</option>' + characters.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                charSelect.value = selectedVal || 'all';
            } else {
                dialogDetails.classList.add('hidden');
            }
            updateSceneDialogContent(sceneBlock);
        };

        const updateSceneDialogContent = (sceneBlock) => {
            const contentContainer = sceneBlock.querySelector('.scene-dialog-content-container');
            const selectedCharId = sceneBlock.querySelector('.scene-dialog-character').value;
            const characters = Array.from(document.querySelectorAll('.character-block')).map(b => ({id: b.dataset.characterId, name: b.querySelector('.character-name').value.trim() || `Karakter ${b.dataset.characterId}`}));
            contentContainer.innerHTML = '';
            if (sceneBlock.querySelector('.scene-dialog-type').value === "tanpa dialog") return;

            const createDialogTextarea = (char) => `<div class="dialog-content-block" data-char-name="${char.name}"><label class="block text-gray-700 text-sm font-medium mb-1">Dialog ${char.name}:</label><textarea class="w-full dialog-content-textarea" rows="2" placeholder="Tulis dialog..."></textarea></div>`;
            
            if (selectedCharId === 'all') {
                contentContainer.innerHTML = characters.map(createDialogTextarea).join('');
            } else if (selectedCharId === 'narrator') {
                contentContainer.innerHTML = createDialogTextarea({ id: 'narrator', name: 'Narator' });
            }
            else { const char = characters.find(c => c.id == selectedCharId); if(char) contentContainer.innerHTML = createDialogTextarea(char); }
        };

        const generateStructuredPrompt = () => {
            const sections = [];

            // Main Prompt
            const videoTypeValue = getDropdownOrFreeTextValue('videoType') || 'video';
            const mainThemeVal = mainThemeInput.value.trim();
            const finalTheme = mainThemeVal || 'subjek tidak spesifik';
            const mainPrompt = `Sebuah ${videoTypeValue} tentang ${finalTheme}.`;
            sections.push(`Main Prompt: ${mainPrompt}`);

            // Main Subject
            const characterPrompts = Array.from(document.querySelectorAll('.character-generated-prompt')).map(el => el.value.trim()).filter(Boolean);
            const productPrompts = Array.from(document.querySelectorAll('.product-generated-prompt')).map(el => el.value.trim()).filter(Boolean);
            const mainSubject = [...characterPrompts, ...productPrompts];
            if (mainSubject.length > 0) {
                sections.push(`Main Subject: ${mainSubject.join('; ')}`);
            }

            // Background
            const time = getDropdownOrFreeTextValue('time');
            const weather = getDropdownOrFreeTextValue('weather');
            const season = getDropdownOrFreeTextValue('season');
            const background = `Berlatar di ${locationInput.value.trim() || 'lokasi tidak spesifik'} pada ${time || 'waktu tidak spesifik'}, cuaca ${weather || 'tidak spesifik'}, musim ${season || 'tidak spesifik'}.`;
            sections.push(`Background: ${background}`);

            // Scene
            const sceneDetails = Array.from(document.querySelectorAll('.scene-block')).map((s, index) => {
                const desc = s.querySelector('.scene-description').value.trim();
                return desc ? `Adegan ${index + 1}: ${desc}.` : null;
            }).filter(Boolean);
            if (sceneDetails.length > 0) {
                sections.push(`Scene: ${sceneDetails.join(' ')}`);
            }

            // Cinematic Specification
            const cinematicSpecs = [];
            document.querySelectorAll('.scene-block').forEach((s, index) => {
                const mov = getDropdownOrFreeTextValue('scene-camera-movement', s);
                const angle = getDropdownOrFreeTextValue('scene-camera-angle', s);
                const focus = getDropdownOrFreeTextValue('scene-camera-focus', s);
                const light = getDropdownOrFreeTextValue('scene-lighting', s);
                const color = getDropdownOrFreeTextValue('scene-color-grading', s);
                const spec = `Adegan ${index + 1}: pergerakan ${mov}, sudut ${angle}, fokus ${focus}, pencahayaan ${light}, warna ${color}.`;
                cinematicSpecs.push(spec);
            });
            const additionalDetailsVal = additionalDetailsTextarea.value.trim();
            if(additionalDetailsVal) cinematicSpecs.push(`Detail Tambahan: ${additionalDetailsVal}`);
            if (cinematicSpecs.length > 0) {
                sections.push(`Cinematic Specification: ${cinematicSpecs.join(' ')}`);
            }

            // Audio
            const audioDetails = Array.from(document.querySelectorAll('.scene-block')).map((s, index) => {
                const audioString = getAudioDetailsForScene(s);
                return audioString.includes('Tanpa dialog') ? null : `Adegan ${index + 1}: ${audioString}`;
            }).filter(Boolean);
            if (audioDetails.length > 0) {
                sections.push(`${audioDetails.join(' ')}`);
            }

            // Style & Quality
            const cameraStyleValue = getDropdownOrFreeTextValue('cameraStyle');
            const videoMoodValue = getDropdownOrFreeTextValue('videoMood');
            const styleAndQuality = `Gaya ${cameraStyleValue || 'tidak spesifik'}, suasana ${videoMoodValue || 'tidak spesifik'}. Kualitas ${videoQualitySelect.value}, rasio ${videoRatioSelect.value}.`;
            sections.push(`Style & Quality: ${styleAndQuality}`);

            // Negative Prompt
            const negativePromptVal = negativePromptInput.value.trim();
            if (negativePromptVal) {
                sections.push(`Negative Prompt: --no ${negativePromptVal}`);
            }

            promptIdOutput.value = sections.join('\n\n');
        };
        
        const clearFields = () => {
            document.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.id !== 'apiKeyInput') {
                    if (el.tagName === 'SELECT') {
                        if (el.options.length > 0) {
                            el.selectedIndex = 0;
                        }
                    } else {
                        el.value = '';
                    }
                }
            });
            characterInputsContainer.innerHTML = ''; 
            productInputsContainer.innerHTML = '';
            sceneInputsContainer.innerHTML = '';
            characterCounter = 0; 
            productCounter = 0;
            sceneCounter = 0;
            imageUpload.value = ''; imagePreviewContainer.classList.add('hidden');
            additionalDetailsTextarea.value = '';
            negativePromptInput.value = '';
            mainThemeInput.value = '';
            smartSceneCount.value = 3;
            generalSubject.value = '';
            addCharacter(); 
            addProduct();
            addScene();
        };

        const getNegativeSuggestion = async () => {
            generateStructuredPrompt(); 
            const fullPrompt = promptIdOutput.value;
            if(!fullPrompt) { showAlert("<p>Susun prompt terstruktur terlebih dahulu.</p>"); return; }
            
            getNegativeSuggestionBtn.innerHTML = '<div class="loader !w-5 !h-5"></div>';
            getNegativeSuggestionBtn.disabled = true;
            
            const prompt = `Dari prompt video ini, berikan list negative prompt relevan (max 10, pisah koma): "${fullPrompt}"`;
            const contentsPayload = [{ parts: [{ text: prompt }] }];
            const responseText = await callGeminiAPI(contentsPayload, false);

            if (responseText) {
                const existingNegative = negativePromptInput.value.trim();
                const newSuggestions = responseText.trim();
                negativePromptInput.value = existingNegative ? `${existingNegative}, ${newSuggestions}` : newSuggestions;
                showAlert("<p>Saran negative prompt ditambahkan.</p>");
            }
            
            getNegativeSuggestionBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>';
            getNegativeSuggestionBtn.disabled = false;
        };

        const executeFinalAiCommand = async (command) => {
            const initialPrompt = promptIdOutput.value.trim();

            if (!initialPrompt) { showAlert("<p>Buat prompt final terlebih dahulu sebelum menjalankan perintah tambahan.</p>"); return; }
            if (!command) { showAlert("<p>Mohon tulis perintah Anda di kolom yang tersedia.</p>"); return; }

            aiCommandLoader.classList.remove('hidden');
            executeAiCommandBtn.disabled = true;
            ultimateCommandBtn.disabled = true;

            const promptToAI = `Berdasarkan prompt video berikut:\n\n"""${initialPrompt}"""\n\nLakukan perintah ini: "${command}".\n\nKembalikan HANYA prompt yang sudah direvisi, tanpa penjelasan tambahan.`;
            const contentsPayload = [{ parts: [{ text: promptToAI }] }];
            const responseText = await callGeminiAPI(contentsPayload, false);
            
            if(responseText){
                promptIdOutput.value = responseText.trim();
                showAlert("<p>Prompt final berhasil diperbarui sesuai perintah Anda.</p>");
            }

            aiCommandLoader.classList.add('hidden');
            executeAiCommandBtn.disabled = false;
            ultimateCommandBtn.disabled = false;
        };
        
        const executeUltimateCommand = () => {
            const ultimatePrompt = `Konteks dan Tujuan Utama:
Prompt Final yang diberikan di atas adalah sebuah naskah lengkap untuk satu film pendek. Karena adanya limit durasi pada platform video AI (seperti Veo 3), naskah tersebut tidak bisa di-generate sekaligus. Tujuan utama Anda adalah memecah Prompt Final tersebut menjadi beberapa prompt terpisah, satu untuk setiap 'Scene' yang didefinisikan di dalamnya, agar siap untuk digenerate satu per satu.
Strategi Konsistensi "Master Bible" (WAJIB DIIKUTI):
Untuk menjaga konsistensi visual di setiap generasi (terutama karena akan ada pergantian akun), Anda HARUS membuat sebuah blok [MASTER BIBLE].

Cara Membuat [MASTER BIBLE]:
Identifikasi SEMUA elemen statis dari Prompt Final: deskripsi detail semua karakter dan produk dari [Main Subject], seluruh [Background], [Style & Quality], dan [Negative Prompt] universal.
Gabungkan semua informasi tersebut ke dalam satu blok teks komprehensif yang diberi nama [MASTER BIBLE].

Cara Menggunakan [MASTER BIBLE]:
Setiap prompt adegan terpisah yang Anda buat HARUS diawali dengan menyertakan salinan LENGKAP dan identik dari [MASTER BIBLE] ini.

Format Output yang Diinginkan:
Hasil akhir dari Anda harus berupa serangkaian prompt yang siap pakai dan mandiri (self-contained). Beri judul dengan jelas untuk setiap prompt (contoh: "PROMPT UNTUK SCENE 1", "PROMPT UNTUK SCENE 2", dst.). Setiap prompt adegan harus berisi:

Blok [MASTER BIBLE] yang lengkap di bagian atas.
Blok [SCENE PROMPT] yang hanya berisi deskripsi aksi, dialog, audio, dan spesifikasi sinematik yang relevan untuk adegan tersebut saja.

Instruksi Tambahan:
Distribusikan semua detail dari bagian [Scene], [Cinematic Specification], dan [Audio] dari naskah asli ke dalam prompt adegan yang sesuai secara logis.
Jika ada informasi yang hilang atau butuh diisi oleh pengguna (seperti tagline), buatkan placeholder yang jelas seperti [TULIS TAGLINE ANDA DI SINI] dan beritahu pengguna tentang itu.
Gunakan Bahasa Inggris untuk bagian prompt teknis yang akan dieksekusi oleh AI video, namun berikan judul dan penjelasan dalam Bahasa Indonesia agar mudah saya (pengguna) pahami.
Jika Anda anggap dalam satu adegan yang hanya 8 detik adegannya terlalu banyak (biasanya hasilnya akan aneh, seperti ada transisi yang terlalu cepat/tidak mulus), Anda harus melakukan:
1. Sederhanakan Montage: Daripada menampilkan terlalu banyak adegan dalam satu klip 8 detik, sederhanakan adegannya.
2. Perjelas Instruksi Transisi: Ganti frasa dengan sesuatu yang lebih sederhana dan tidak ambigu, seperti "a series of simple, clean cuts".
3. Pisahkan Generasi (Kontrol Maksimal): Jika perlu, sarankan untuk memisahkan satu adegan kompleks menjadi beberapa generasi terpisah.`;

            aiFinalCommandInput.value = ultimatePrompt;
            executeFinalAiCommand(ultimatePrompt);
        };

        // --- IMPORT/EXPORT FUNCTIONS ---
        const handleExport = () => {
            const appState = {
                general: {},
                characters: [],
                products: [],
                scenes: []
            };

            appState.general.mainTheme = mainThemeInput.value;
            appState.general.videoType = videoTypeSelect.value;
            appState.general.cameraStyle = cameraStyleSelect.value;
            appState.general.cameraStyleFree = cameraStyleFreeInput.value;
            appState.general.videoMood = videoMood.value;
            appState.general.videoMoodFree = getById('videoMood-free').value;
            appState.general.generalSubject = generalSubject.value;
            appState.general.location = locationInput.value;
            appState.general.time = time.value;
            appState.general.timeFree = getById('time-free').value;
            appState.general.weather = weather.value;
            appState.general.weatherFree = getById('weather-free').value;
            appState.general.season = season.value;
            appState.general.seasonFree = getById('season-free').value;
            appState.general.videoQuality = videoQualitySelect.value;
            appState.general.videoRatio = videoRatioSelect.value;
            appState.general.additionalDetails = additionalDetailsTextarea.value;
            appState.general.negativePrompt = negativePromptInput.value;

            document.querySelectorAll('.character-block').forEach(block => {
                const charData = {};
                block.querySelectorAll('input, textarea, select').forEach(el => {
                    if(el.classList.length > 0) charData[el.className.split(' ')[0]] = el.value;
                });
                appState.characters.push(charData);
            });

            document.querySelectorAll('.product-block').forEach(block => {
                const prodData = {};
                block.querySelectorAll('input, textarea').forEach(el => {
                     if(el.classList.length > 0) prodData[el.className.split(' ')[0]] = el.value;
                });
                appState.products.push(prodData);
            });

            document.querySelectorAll('.scene-block').forEach(block => {
                const sceneData = {};
                block.querySelectorAll('input, textarea, select').forEach(el => {
                    if (el.classList.length > 0) sceneData[el.className.split(' ')[0]] = el.value;
                });
                appState.scenes.push(sceneData);
            });

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "veo_prompt_settings.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showAlert('Pengaturan berhasil diekspor!');
        };

        const handleImport = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    try {
                        const content = readerEvent.target.result;
                        const loadedState = JSON.parse(content);
                        populateAllFields(loadedState);
                        showAlert('Pengaturan berhasil diimpor!');
                    } catch (err) {
                        showAlert('Gagal memuat file. Pastikan file JSON valid.');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            }
            input.click();
        };
        
        const populateAllFields = (state) => {
            clearFields();

            const gen = state.general || {};
            mainThemeInput.value = gen.mainTheme || '';
            videoTypeSelect.value = gen.videoType || '';
            cameraStyleSelect.value = gen.cameraStyle || '';
            cameraStyleFreeInput.value = gen.cameraStyleFree || '';
            videoMood.value = gen.videoMood || '';
            getById('videoMood-free').value = gen.videoMoodFree || '';
            generalSubject.value = gen.generalSubject || '';
            locationInput.value = gen.location || '';
            time.value = gen.time || '';
            getById('time-free').value = gen.timeFree || '';
            weather.value = gen.weather || '';
            getById('weather-free').value = gen.weatherFree || '';
            season.value = gen.season || '';
            getById('season-free').value = gen.seasonFree || '';
            videoQualitySelect.value = gen.videoQuality || 'Full HD';
            videoRatioSelect.value = gen.videoRatio || 'LANDSCAPE 16:9';
            additionalDetailsTextarea.value = gen.additionalDetails || '';
            negativePromptInput.value = gen.negativePrompt || '';

            characterInputsContainer.innerHTML = ''; characterCounter = 0;
            (state.characters || []).forEach(charData => {
                const newBlock = addCharacter(false);
                if (newBlock) {
                    Object.keys(charData).forEach(key => {
                        const el = newBlock.querySelector(`.${key}`);
                        if (el) el.value = charData[key];
                    });
                }
            });

            productInputsContainer.innerHTML = ''; productCounter = 0;
            (state.products || []).forEach(prodData => {
                const newBlock = addProduct(false);
                 if (newBlock) {
                    Object.keys(prodData).forEach(key => {
                        const el = newBlock.querySelector(`.${key}`);
                        if (el) el.value = prodData[key];
                    });
                }
            });
            
            sceneInputsContainer.innerHTML = ''; sceneCounter = 0;
            (state.scenes || []).forEach(sceneData => {
                const newBlock = addScene(false);
                 if (newBlock) {
                    Object.keys(sceneData).forEach(key => {
                        const el = newBlock.querySelector(`.${key}`);
                        if (el) el.value = sceneData[key];
                    });
                }
            });

            updateAllDropdowns();
        };

        const generateDialogue = async (sceneBlock) => {
            const sceneDescription = sceneBlock.querySelector('.scene-description').value.trim();
            if (!sceneDescription) { showAlert('Isi deskripsi adegan terlebih dahulu.'); return; }

            const characters = Array.from(document.querySelectorAll('.character-block')).map(b => b.querySelector('.character-name').value.trim() || `Karakter ${b.dataset.characterId}`);
            if (characters.length < 1) { showAlert('Tambahkan setidaknya satu karakter untuk membuat dialog.'); return; }

            const prompt = `Untuk sebuah adegan dengan deskripsi: "${sceneDescription}", dan suasana video: "${getDropdownOrFreeTextValue('videoMood')}", buatkan contoh dialog natural yang singkat antara karakter berikut: ${characters.join(', ')}. Kembalikan hasilnya SEBAGAI OBJEK JSON yang valid. Kunci (key) adalah nama karakter (string), dan nilai (value) adalah dialognya (string). Contoh: {"Nama Karakter 1": "Dialognya...", "Nama Karakter 2": "Dialognya..."}`;

            const btn = sceneBlock.querySelector('.generate-dialogue-btn');
            btn.textContent = 'Membuat...';
            btn.disabled = true;

            const contentsPayload = [{ parts: [{ text: prompt }] }];
            const responseText = await callGeminiAPI(contentsPayload);

            if (responseText) {
                try {
                    const dialogues = parseJsonResponse(responseText);
                    sceneBlock.querySelectorAll('.dialog-content-block').forEach(dialogBlock => {
                        const charName = dialogBlock.dataset.charName;
                        const textarea = dialogBlock.querySelector('.dialog-content-textarea');
                        if (dialogues[charName]) {
                            textarea.value = (textarea.value ? textarea.value + '\n' : '') + dialogues[charName];
                        }
                    });
                    showAlert('Dialog berhasil dibuat dan diisi.');
                } catch (error) {
                    console.error("Dialogue Parse Error:", error);
                    showAlert(`<p>Gagal memproses respons dialog dari AI: ${error.message}</p>`);
                }
            }
            
            btn.textContent = '✨ Buatkan Dialog';
            btn.disabled = false;
        };


        // --- INITIALIZATION ---
        getStoryOptionsBtn.addEventListener('click', getStoryOptions);
        developIdeaBtn.addEventListener('click', developIdeaIntoDetails);
        addCharacterBtn.addEventListener('click', () => addCharacter());
        addProductBtn.addEventListener('click', () => addProduct());
        addSceneBtn.addEventListener('click', () => addScene());
        generateBtn.addEventListener('click', generateStructuredPrompt);
        clearBtn.addEventListener('click', clearFields);
        exportBtn.addEventListener('click', handleExport);
        importBtn.addEventListener('click', handleImport);
        getNegativeSuggestionBtn.addEventListener('click', getNegativeSuggestion);
        generateBackgroundBtn.addEventListener('click', generateCreativeBackground);
        ultimateCommandBtn.addEventListener('click', executeUltimateCommand);
        
        executeAiCommandBtn.addEventListener('click', () => executeFinalAiCommand(aiFinalCommandInput.value));

        getById('copy-prompt-id-btn').addEventListener('click', () => { 
            const ta = getById('promptId');
            if(ta.value) { 
                ta.select();
                document.execCommand('copy');
                showAlert('<p>Prompt berhasil disalin!</p>'); 
            }
        });
        closeWelcomeBtn.addEventListener('click', () => { welcomeModal.style.display = 'none'; });
        window.onclick = (event) => { if (event.target == welcomeModal || event.target == modal) event.target.style.display = "none"; };
        
        cameraStyleSelect.addEventListener('change', updateStyleKeywords);
        cameraStyleFreeInput.addEventListener('input', updateStyleKeywords);
        
        document.addEventListener('DOMContentLoaded', () => { 
            welcomeModal.style.display = 'flex'; 
            addCharacter(); 
            addProduct();
            addScene();
        });
    </script>
</body>
</html>
